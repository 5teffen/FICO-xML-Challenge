<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>expl</title>
        <script src="js/countline.js"></script>
        <script src="js/d3.min.js"></script>
        <script src="js/worker.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="buttons.css">
    </head>
    <body onload="start(false,false)">
        
        <input disabled placeholder="lower thr." id='tl' type='text' value="0.59999999999999998">
        <input disabled placeholder="upper thr." id='tr' type='text' value="0.59999999999999998">
<!--         <input placeholder="docs folder" id='folder' type='text' value="yelp">
        <input type='password' id='pwd' type='text' placeholder="password"> -->
        <button class="myButton but1" onClick='start(true,false);'>Run</button>
        <br>
        <br>
        <br>
        

        <svg class='sortbutton' style='position: absolute;'>
            <rect class='real'></rect>
            <rect class='real1'></rect>
            <rect class='dst'></rect>
            <rect class='tp'></rect>
            <rect class='tn'></rect>
            <rect class='fp'></rect>
            <line class='fpl1'></line>
            <line class='fpl2'></line>
            <rect class='fn'></rect>
            <line class='fnl1'></line>
            <line class='fnl2'></line>
            <rect class='full'></rect>
            <rect class='periods'></rect>
            <rect class='words'></rect>
            <text class='srt'>
                <tspan class = 'lineone'></tspan>
                <tspan class = 'linetwo'></tspan>
            </text>
            <text class='dst'>
                <tspan class = 'lineone'></tspan>
                <tspan class = 'linetwo'></tspan>
            </text>
            <text class='rst'>
                <tspan class = 'lineone1'></tspan>
            </text>
            <text class='full'>
                <tspan class = 'lineone1'></tspan>
            </text>
            <text class='periods'>
                <tspan class = 'lineone1'></tspan>
            </text>
            <text class='words'>
                <tspan class = 'lineone1'></tspan>
            </text>
            <rect class='fake'></rect>
            <rect class='fake1'></rect>
            <rect class='dstf'></rect>
            <rect class='tpf'></rect>
            <rect class='tnf'></rect>
            <rect class='fpf'></rect>
            <rect class='fnf'></rect>

            <rect class='fkfull'></rect>
            <rect class='fkperiods'></rect>
            <rect class='fkwords'></rect>
        </svg>
        
            <img style="opacity:0;" class='loadZ' src='load.gif'\>

        <div class="main" style="position:relative;height=100%;">
            <div id="chart" style="z-index: 100; position:absolute;left: 30%;"></div>
            <div class='docs_cont' id='docs'>
                <img style="opacity:0;" class='load1' src='load.gif'\>
            </div>
            
            <div class='words_div' id='wordToScroll'>


            <svg class='words'>
                <text class='column_lab1'></text>
                <text class='column_lab2'></text>
                <text class='column_lab2_3'></text>
                <text class='column_lab3'></text>
            </svg>
            </div>
            <div class='lista_div' id='exps'>
            
                <img style="opacity:0;" class='load2' src='load.gif'\>
                <img style="opacity:0;" class='load0' src='load.gif'\>
                
                <svg class='lista'>
                    <line x1="550" y1="0" x2="550" y2="100%"/>
                    <text class='column_lab1'></text>
                    <text class='column_lab2'></text>
                    <text class='column_lab3'></text>
                    <text class='column_lab4'></text>
                </svg>
            </div>
            
        </div>

        <!-- <p id="status"></p> -->
    <script>

    d3.select("#tr").style("visibility","hidden")


    var _fmt = d3.format(".3g");
    var fmt = function(v) {
    if(Math.floor(v) === v) {
      return "" + v;
    }
    return _fmt(v);
    };

    var colorPositive = "#67a9cf"
    var colorNegative = "#ef8a62"
    var colorLessPos = "#d1e5f0"
    var colorLessNeg = "#fddbc7"

    function onROCThreshold(rocT, left) {
        left = true
        if(left) {
          thres_left = rocT;
          //d3.select("#tr").attr("value",rocT)
          //d3.select("#tl").attr("value",rocT)
        } else {
          thres_right = rocT;
          d3.select("#tl").attr("value",rocT)
        }   
             
        }

    var COLOR_LEFT_DARK = "#2166ac";
    var COLOR_LEFT = colorPositive;
    var COLOR_LEFT_BRIGHT = "#d1e5f0";
    var COLOR_MID = "white";
    var COLOR_RIGHT_DARK = "#b2182b";
    var COLOR_RIGHT = colorNegative;
    var COLOR_RIGHT_BRIGHT = "#fddbc7";
    var COLOR_SEL = "khaki";
    var COLOR_FIX = "forestgreen";
    var COLOR_TMP = "lightgray";



    var ch = new CountLine(d3.select("#chart"), 500, 200, 30, 
        onROCThreshold, d3.select("#score_tmp"), 
        fmt, 
        [ COLOR_LEFT, COLOR_RIGHT, COLOR_TMP, COLOR_LEFT_DARK, COLOR_RIGHT_DARK ]);
    function onROCTemp(score) {
        ch.setROCTemp(score);
    }

    ch.onROCTemp(onROCTemp);
    var points = []




    var are_we_full = false;
    function start(letsgo,change_thr) {

            function realStart(){





                    d3.select("svg.sortbutton").transition()
                    .duration(500).style("visibility","hidden")
                    d3.select("div.main").transition()
                    .duration(500).style("visibility","hidden")
                    loadImageAll.transition()
                    .duration(500).style({ "opacity": "1"});
                        work.post("importantWords", "words", {
                        "l": thresholdLeft,
                        "r": thresholdRight,
                        "token" : pwd,
                                }, function(newData) {
                                    
                                    impW = newData;
                                    allWords = impW.length
                                    ixsImpWords = impW.map(function(_, ix) {
                                    return ix;
                                });
                                slice_ixsImpWords = ixsImpWords.slice(0,howManyKeyWords)
                                slice_ImpWords = impW.slice(0,howManyKeyWords)

                                update();
                                
                                
                                d3.select("svg.sortbutton").transition()
                    .duration(500).style("visibility","visible")
                                d3.select("div.main").transition()
                    .duration(500).style("visibility","visible")
                                }); }

        var work = new quick_server.Worker();
        work.status(function(req) {
        d3.select("#status").text(req ? req + "x" : "");
        });

        //var thresholdLeft = +document.getElementById('tl').value;
        var thresholdLeft = +document.getElementById('tl').value;
        //var thresholdLeft = 0.59999999999999998
        var thresholdRight = thresholdLeft

        work.post("get-thr", "opt-thr", {
        "noarg": "noarg",
        }, function(newData) {
                thresholdsUselessList = newData;
                thresholdLeft = thresholdsUselessList[0]
                thresholdRight = thresholdsUselessList[1]
                d3.select("#tr").attr("value",thresholdRight)
                d3.select("#tl").attr("value",thresholdLeft)
                });   

        var allWords;
        var expSize = 15;
        var sentSort = false;
        var errSort = false;
        var freqSort = true;
        var numbFeat = 0;
        var folderOfDocs = "yelp";//document.getElementById('folder').value;

        var pwd = 0;//hashCode(document.getElementById('pwd').value);
        var span_labels = 42;
        var queryData = [];
        var wordsLeft = [];
        var wtf1 = 28;
        var wtf2 = 30;

        var impW = [];
        var exp = [];
        var noDup = [];
        var ixsImpWords = [];
        var docContent = [];

        var loading = true;
        var lengthOfKeyWords = new Array(impW.length);
        var rightSizeofKW;
        var lengthOfExps = new Array(queryData.length);
        var occWhenFewDocs = new Array(queryData.length);
        var rightSizeofExp = 150;
        
        var selectedSquarino = "none"
        
        var whichDocs = "all";
        var argGetDoc = new Array(4);
        var allDocs = new Array();
        var TPDocs = new Array();
        var TNDocs = new Array();
        var FPDocs = new Array();
        var FNDocs = new Array();

        var TPPred = new Array();
        var TNPred = new Array();
        var FPPred = new Array();
        var FNPred = new Array();



        var isItClicked = new Array(impW.length);
        var isItClickedExp = new Array(queryData.length);
        var colorDist2 = d3.scale.linear().domain([1, thresholdLeft]).range([colorPositive, colorLessPos]);
        var colorDist3 = d3.scale.linear().domain([thresholdLeft, 0.0]).range([colorLessNeg, colorNegative]);

        var whichDocFormat = "full";


        var images = d3.selectAll("img")
                        .style({
                                "z-index" : "100",
                                "overflow" : "visible",
                                "pointer-events" : "none",
                                "background" : "none !important",})

        var loadImageAll = d3.select("img.loadZ")
                         .style({
                                "position": "absolute",
                                "left": "45%",
                                "top": "100px"})

        var loadImageDocs = d3.select("img.load1")
                         .style({
                                "position": "absolute",
                                "left": "43.6%",
                                "top": "100px"})
        var loadImageFinger = d3.select("img.load2")
                         .style({
                                "position": "absolute",
                                "left": String(870-150)+"px",
                                "top": "100px"})
             
        var loadImageExp = d3.select("img.load0")
                         .style({
                                "position": "absolute",
                                "left": "200px",
                                "top": "100px"})
        var slice_ixsImpWords = []
        var slice_ImpWords = []
        var howManyKeyWords = 25;
        var altezza = 900;
        var gapscroll =0
        var gapscrollWholeDiv = 15
        var last_known_scroll_position = 0;


        if(!letsgo && !change_thr){

            work.post("pre_stats", "roc", {
                "noarg": "noarg",
            }, function(newData) {
                            points = newData;
                            ch.points(points);
                            ch.setROCThreshold(thresholdRight, true);
                            ch.setROCThreshold(thresholdLeft, false);                     
                            ch.update(); });   }
        

        else if (!letsgo && change_thr){

            d3.select("button.but1").html("Run")
            .attr("onClick","start(true,false);")



            d3.select("#chart").style("visibility","visible")
            d3.select("svg.sortbutton").style("visibility","hidden")
            d3.select("div.main").style("visibility","hidden")
            ch.setROCThreshold(thresholdRight, true);
            ch.setROCThreshold(thresholdLeft, false);                  
            ch.update();             
        }
        else if(letsgo && !change_thr){

            d3.select("button.but1").html("Histogram")
            .attr("onClick","start(false,true);")

            d3.select("#chart").style("visibility","hidden")
            
            realStart();

        }

       function update() {


            var myDiv = document.getElementById("wordToScroll")

            // or "hidden"?
            
            loadImageAll.transition()
            .duration(500).style({ "opacity": "0"});
            loadImageDocs.transition()
            .duration(500).style({ "opacity": "0"});
            loadImageFinger.transition()
            .duration(500).style({ "opacity": "0"});
            loadImageExp.transition()
            .duration(500).style({ "opacity": "0"});
            var buttonSvg = d3.select("body")
            .select("svg.sortbutton")
            .style({
                "position": "relative",
                "top" :"0px",
                "width":String(gapscrollWholeDiv+1000+150+rightSizeofKW+440)})
            .attr("height",65);

            buttonSvg.select("rect.real")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","#E0E0E0")
            .attr("x",5)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("stroke","black");

            buttonSvg.select("rect.real1")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","#E0E0E0")
            .attr("x",125)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("stroke","black");
            
            buttonSvg.select("rect.fake")
            .attr("width",90)
            .attr("height",60)
            .attr("fill","grey")
            .attr("x",5)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("opacity",0)
            .attr("stroke","black")
            .on("click",function(){
                myDiv.scrollTop = 0;
                var answers = newSort(slice_ixsImpWords,slice_ImpWords,errSort,freqSort,sentSort)
                errSort = answers[0]
                freqSort = answers[1]
                sentSort = answers[2]
                update();})
            .on("mouseover", function() {
                d3.select(this.parentNode).select("text.srt")
                .attr("font-size",14); })
            .on("mouseout", function() {
                d3.select(this.parentNode).select("text.srt")
                .transition()
                .duration(350)
                .attr("font-size",12); });
                
            buttonSvg.select("rect.fake1")
            .attr("width",90)
            .attr("height",60)
            .attr("fill","grey")
            .attr("x",125)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("opacity",0)
            .attr("stroke","black")
            .on("click",function(){

                myDiv.scrollTop = 0;
                howManyKeyWords = 25
                errSort = false
                freqSort = true
                sentSort = false
                slice_ixsImpWords = ixsImpWords.slice(0,howManyKeyWords)
                slice_ImpWords = impW.slice(0,howManyKeyWords) 
                loading = true;
                selectedSquarino = "none"
                whichDocs = "all";
                isItClicked = new Array(impW.length)
                queryData = [];
                wordsLeft = [];
                bigQuery = [];
                docContent = [];
                argGetDoc = new Array(4);
                TPDocs = new Array();
                TNDocs = new Array();
                FPDocs = new Array();
                FNDocs = new Array();
                TNPred = new Array();
                TPPred = new Array();
                FNPred = new Array();
                FPPred = new Array();
                update();})
            .on("mouseover", function() {
                d3.select(this.parentNode).select("text.rst")
                .attr("font-size",15); })
            .on("mouseout", function() {
                d3.select(this.parentNode).select("text.rst")
                .transition()
                .duration(350)
                .attr("font-size",14);});
            
            
            
            var buttonText = buttonSvg.select("text.srt")
            .attr("font-family","Verdana")
            .attr("font-size",14);

            
            buttonText.select("tspan.lineone")
            .attr("text-anchor","middle")
            .attr("x",50)
            .attr("y",25)
            .text("Sorted by");
            
            var buttonText1 = buttonSvg.select("text.rst")
            .attr("font-family","Verdana")
            .attr("font-size",14);
            
            
            buttonText1.select("tspan.lineone1")
            .attr("text-anchor","middle")
            .attr("x",170)
            .attr("y",30)
            .text("Reset");
            
            
            
            buttonText.select("tspan.linetwo")
            .attr("text-anchor","middle")
            .attr("x",50)
            .attr("y",25)
            .attr("dy","1.2em")
            .text(function(){
                if (errSort){
                    return "error";}
                else if (freqSort){
                    return "frequency"}
                else if (sentSort){
                    return "sentiment"}
                else {
                    return "wtf"}});
                    

            
            var wordsSvg = d3.select("body")
            .select("svg.words")
            .attr("height", function(){
                    var alt = Math.max(wtf1 * queryData.length, wtf2 * impW.length)
                    var alt2 = Math.max(alt,82+(25+15)*docContent.length)
                    if (loading){
                        return 950
                    }
                    else {
                        return (span_labels + 40) + wtf2 * howManyKeyWords
                    }
                    })
            .style({
                "border-left": "1px solid #E0E0E0",
                "overflow-y": "scroll",});
                
            var wordsDiv = d3.select("div.words_div")
            .style({
                "overflow":"auto",
                "width": "auto",
                "height":String(altezza)+"px",
                "position":"absolute"});

            var listaDiv = d3.select("div.lista_div")
            .style({
                "overflow":"auto",
                "width":String(1000)+"px",
                "height":String(altezza)+"px",
                "position":"absolute",
                "top":"0px",
                "border-right": "1px solid #E0E0E0",});
            
           

            var listExpSvg = d3.select("body")
            .select("svg.lista")
            .attr("height", function(){
                    var alt = Math.max(wtf1 * queryData.length, altezza)
                    var lol = 82+(25+15)*docContent.length
                    var alt2 = Math.max(alt,lol)
                    if (lol  > 0) {
                        return alt2}
                    else {
                        return alt}})
            .style("width", "100%");
            
        

                
            
            /////////////////////////////
            

            var groupsWords = wordsSvg.selectAll("g")
            .data(slice_ixsImpWords,function(ix) {
              return ix;
            });
            
            groupsWords.exit().remove();
            
            grWEnter = groupsWords.enter()
            .append("g");
            groupsWords.order();
            
            
            /////////////////////////////
            
            grWEnter.append("text");

            groupsWords.select("text")
            .attr("font-family","Verdana")
            .text(function(d){
                return impW[d].term;})
            .attr("font-size",expSize)
            .attr("font-size",function(d,i){
                    lengthOfKeyWords[i] = this.getComputedTextLength() 
                return expSize;});
                
            groupsWords.select('text')
            .transition()
            .duration(350)
            .attr('y', function(d,i){
                return span_labels +20+(i) * (30)+20;})
            .attr("x",20);
            

            
            rightSizeofKW = d3.max(lengthOfKeyWords)+25
            
            
            /////////////////////////////
            
            wordsSvg.select('line').attr("stroke","#E0E0E0");
            
            wordsSvg.select('text.column_lab1')
            .attr("x",35)
            .attr("y",30)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 66 39)")
            .text("keyword");
            
             wordsSvg.select('text.column_lab2')
            .attr("x",25 + rightSizeofKW)
            .attr("y",30)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(41 + rightSizeofKW)+" 39)")            
            .text("ratio");
            
            
            wordsSvg.select('text.column_lab2_3')
            .attr("x",50 + rightSizeofKW)
            .attr("y",30)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(75 + rightSizeofKW)+" 39)")
            .text("errors")
            
            
             wordsSvg.select('text.column_lab3')
            .attr("x",80 + rightSizeofKW)
            .attr("y",30)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(105 + rightSizeofKW)+" 39)")
            .text("# exp")
            
            
            
            /////////////////////////////
            
            grWEnter.append("rect").classed("bad", true);
            
            groupsWords.select("rect.bad")
            .attr("width", function(d,i){
                            return (impW[d].errors)*20})
            .attr("height", 10)
            .attr("fill","black")
            .attr("stroke","black")
            .attr("stroke-width",0.5);
            
            groupsWords.select("rect.bad")
            .transition()
            .duration(350)
            .attr("x", 40 + rightSizeofKW)
            .attr("y", function(d,i){
                            return span_labels +30 +i * (30)});
            
            /////////////////////////////
            
            grWEnter.append("rect").classed("good", true);
            
            groupsWords.select("rect.good")
            .attr("width",function(d,i){
                            return (1-impW[d].errors)*20})
            .attr("height", 10)
            .attr("fill","white")
            .attr("stroke","black")
            .attr("stroke-width",0.5);

            
            groupsWords.select("rect.good")
            .transition()
            .duration(350)
            .attr("x",function(d,i){
                  return 40 + rightSizeofKW+(impW[d].errors)*20})
            .attr("y", function(d,i){
                            return span_labels +30 +i * (30)});

            
            /////////////////////////////
            
            grWEnter.append("rect").classed("totOcc", true);
            
            maxFreq = getMax(impW,'freq').freq;
            
            groupsWords.select("rect.totOcc")
            .attr("width", function(d,i){ return +impW[d].freq/maxFreq*50})
            .attr("height", 10)
            .attr("fill","#E0E0E0");
            
            groupsWords.select('rect.totOcc')
            .transition()
            .duration(350)
            .attr('y', function(d,i){
                return span_labels +30 +i * (30);})
            .attr("x",70 + rightSizeofKW);
            
            /////////////////////////////
            
            grWEnter.append("rect").classed("labRect", true);
            
            groupsWords.select("rect.labRect")
            .attr("width", 10)
            .attr("height", 10)
            .attr("fill",function(d,i) {
                if(impW[d].ratio >= thresholdLeft){
                    return colorDist2(impW[d].ratio);
                }
                else{
                    return colorDist3(impW[d].ratio);
                }
                
                });
            
            groupsWords.select('rect.labRect')
            .transition()
            .duration(350)
            .attr('y', function(d,i){
                return span_labels +30 +i * (30);})
            .attr("x",20 + rightSizeofKW);
            
            /////////////////////////////
            
            grWEnter.append("circle").classed("selCirc", true);
            
            groupsWords.select("circle.selCirc")
            .attr("r", 4)
            .attr("fill","black")
            .attr("opacity",function(d,i) {
                if (isItClicked[d]) {
                    return(100);}
                else {
                    return(0);}});
            
            groupsWords.select('circle.selCirc')
            .transition()
            .duration(350)
            .attr('cy', function(d,i){
                return span_labels +30 +i * (30)+6;})
            .attr("cx",12);
            
            /////////////////////////////
            
            grWEnter.append("rect").classed("invisible_layer", true);
            
            groupsWords.select('rect.invisible_layer')
            .attr("width", 140 + rightSizeofKW)
            .attr("height", 25)
            .on("click",function(d,i) {
                selectedSquarino = "none"
                whichDocs = "all";
                if (wordsLeft.indexOf(impW[d].term) > -1 || wordsLeft.length == 0 || wordsLeft.indexOf(impW[d].term) > -1){
                    queryData = [];
                wordsLeft = [];
                argGetDoc = new Array(4);
                TPDocs = new Array();
                TNDocs = new Array();
                FPDocs = new Array();
                FNDocs = new Array();
                TNPred = new Array();
                TPPred = new Array();
                FNPred = new Array();
                FPPred = new Array();
                isItClicked[d] = !isItClicked[d]
                bigQuery = [];
                docContent = [];
                for (d in isItClicked){
                    if (isItClicked[d]){
                        bigQuery.push(impW[d].term)}} 
                newList(bigQuery,i,d);}
                else {
                    return}})
            .attr("fill","white")
            .attr('y', function(d,i){
                return span_labels +20 +i * (30);})
            .attr("x",10)
            .attr("opacity",function(d){
                if (wordsLeft.length == 0){
                    return 0}
                else {
                if(wordsLeft.indexOf(impW[d].term) > -1){
                    return 0}
                else if (!wordsLeft.indexOf(impW[d].term) > -1){
                    return 0.75}}})
            .on("mouseover",function(){
                d3.select(this.parentNode).select("text")
                .attr("font-size",expSize+2);})
            .on("mouseout",function(){
                d3.select(this.parentNode).select("text")
                .transition()
                .duration(350)
                .attr("font-size",expSize);});
                
            /////////////////////////////



            setTimeout(function(){ 
                groupsWords.select('text')
                .attr('y', function(d,i){
                    return span_labels +20+(i) * (30)+20;})
                .attr("x",20); 

                groupsWords.select("rect.bad")
                .attr("x", 40 + rightSizeofKW)
                .attr("y", function(d,i){
                                return span_labels +30 +i * (30)});

                groupsWords.select("rect.good")
                .attr("x",function(d,i){
                      return 40 + rightSizeofKW+(impW[d].errors)*20})
                .attr("y", function(d,i){
                                return span_labels +30 +i * (30)});

                groupsWords.select('rect.totOcc')
                .attr('y', function(d,i){
                    return span_labels +30 +i * (30);})
                .attr("x",70 + rightSizeofKW);

                groupsWords.select('rect.labRect')
                .attr('y', function(d,i){
                    return span_labels +30 +i * (30);})
                .attr("x",20 + rightSizeofKW);


                groupsWords.select('circle.selCirc')
                .attr('cy', function(d,i){
                    return span_labels +30 +i * (30)+6;})
                .attr("cx",12);

            }, 350);


            /////////////////////////////
            /////////////////////////////      
            
            buttonSvg.style("width",String(gapscrollWholeDiv+1000+150+rightSizeofKW+440))
            
            wordsSvg.style("width", String((150 + rightSizeofKW))+"px")
            
            listaDiv.style({
                "left":String((gapscrollWholeDiv+150 + rightSizeofKW))+"px"})
            
            /////////////////////////////
            /////////////////////////////
            
            buttonSvg.select("rect.dst")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","#E0E0E0")
            .attr("x",gapscrollWholeDiv + 150 + rightSizeofKW + 20 )
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("stroke","black");            
                
            buttonSvg.select("rect.dstf")
            .attr("width",90)
            .attr("height",60)
            .attr("fill","grey")
            .attr("x",gapscrollWholeDiv + 150 + rightSizeofKW + 20)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("opacity",0)
            .attr("stroke","black")
            .on("click",function(){
                window.open('stats.html?tr='+String(thresholdRight)+'&tl='+String(thresholdLeft));})
            .on("mouseover", function() {
                d3.select(this.parentNode).select("text.dst")
                .attr("font-size",15); })
            .on("mouseout", function() {
                d3.select(this.parentNode).select("text.dst")
                .transition()
                .duration(350)
                .attr("font-size",14);});
            
            var buttonTextDST = buttonSvg.select("text.dst")
            .attr("font-family","Verdana")
            .attr("font-size",14);

            
            buttonTextDST.select("tspan.lineone")
            .attr("text-anchor","middle")
            .attr("x",gapscrollWholeDiv + 150 + rightSizeofKW + 20 +45)
            .attr("y",25)
            .text("Show Data");
            
            buttonTextDST.select("tspan.linetwo")
            .attr("text-anchor","middle")
            .attr("x",gapscrollWholeDiv + 150 + rightSizeofKW + 20 +45)
            .attr("y",50)
            .text("Stats");
            
            /////////////////////////////
            var gap = 50
            
            buttonSvg.select("rect.full")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","#E0E0E0")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + gap)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if (whichDocFormat == "full"){
                    return 3 }
                else {
                    return 1}});
            
            buttonSvg.select("rect.periods")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","#E0E0E0")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + 120 + gap)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if (whichDocFormat == "periods"){
                    return 3 }
                else {
                    return 1}});
            
            buttonSvg.select("rect.words")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","#E0E0E0")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + 120*2 + gap)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if (whichDocFormat == "words"){
                    return 3 }
                else {
                    return 1}});
            
            
            buttonSvg.select("rect.fkfull")
            .attr("width",90)
            .attr("height",57)
            .attr("fill","white")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + gap)
            .attr("y",3)
            .attr("rx",15)
            .attr("ry",15)
            .attr("opacity",0)
            .attr("stroke","black")
            .on("click",function(){
                whichDocFormat = "full"
                update();})
            .on("mouseover", function() {
                d3.select(this.parentNode).select("text.full")
                .attr("font-size",16); })
            .on("mouseout", function() {
                d3.select(this.parentNode).select("text.full")
                .transition()
                .duration(350)
                .attr("font-size",12); });
                
            buttonSvg.select("rect.fkperiods")
            .attr("width",95)
            .attr("height",62)
            .attr("fill","white")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + gap + 120-3)
            .attr("y",1)
            .attr("rx",15)
            .attr("ry",15)
            .attr("opacity",0)
            .attr("stroke-width",1)
            .on("click",function(){
                whichDocFormat = "periods"
                update();})
            .on("mouseover", function() {
                d3.select(this.parentNode).select("text.periods")
                .attr("font-size",16); })
            .on("mouseout", function() {
                d3.select(this.parentNode).select("text.periods")
                .transition()
                .duration(350)
                .attr("font-size",12); });
                
            buttonSvg.select("rect.fkwords")
            .attr("width",95)
            .attr("height",62)
            .attr("fill","white")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + gap + 120*2-3)
            .attr("y",1)
            .attr("rx",15)
            .attr("ry",15)
            .attr("opacity",0)
            .attr("stroke-width",1)
            .on("click",function(){
                whichDocFormat = "words"
                update();})
            .on("mouseover", function() {
                d3.select(this.parentNode).select("text.words")
                .attr("font-size",16); })
            .on("mouseout", function() {
                d3.select(this.parentNode).select("text.words")
                .transition()
                .duration(350)
                .attr("font-size",12); });
            
             var buttonTextFull = buttonSvg.select("text.full")
            .attr("font-family","Verdana")
            .attr("font-size",14);
            
            
            buttonTextFull.select("tspan.lineone1")
            .attr("text-anchor","middle")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + gap +45)
            .attr("y",30)
            .text("Full");
            
            var buttonTextPer = buttonSvg.select("text.periods")
            .attr("font-family","Verdana")
            .attr("font-size",14);
            
            
            buttonTextPer.select("tspan.lineone1")
            .attr("text-anchor","middle")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + 120 + gap+45)
            .attr("y",30)
            .text("Periods");
            
            var buttonTextWords = buttonSvg.select("text.words")
            .attr("font-family","Verdana")
            .attr("font-size",14);
            
            
            buttonTextWords.select("tspan.lineone1")
            .attr("text-anchor","middle")
            .attr("x",gapscrollWholeDiv+1000+150+rightSizeofKW + 120*2 + gap+45)
            .attr("y",30)
            .text("Words");
            
            /////////////////////////////
            
            var ticking = false;
            
            function doSomething(a,b,c) {
                if(b-a === c && !are_we_full ){

                    howManyKeyWords = howManyKeyWords + 10
                    if (howManyKeyWords <= allWords){
                        loading = false;
                        slice_ixsImpWords = ixsImpWords.slice(0,howManyKeyWords)
                        slice_ImpWords = impW.slice(0,howManyKeyWords)
                        errSort = false
                        freqSort = true
                        sentSort = false
                        update() }
                    else{are_we_full = true
                        howManyKeyWords = allWords
                        loading = false;
                        slice_ixsImpWords = ixsImpWords.slice(0,howManyKeyWords)
                        slice_ImpWords = impW.slice(0,howManyKeyWords)
                        errSort = false
                        freqSort = true
                        sentSort = false
                        update()} } }

            myDiv.addEventListener('scroll', function(e) {

                a = parseInt(myDiv.scrollTop);
                b = myDiv.scrollHeight;
                c = myDiv.clientHeight;
                doSomething(a,b,c); });
    
                    
       
            /////////////////////////////
            /////////////////////////////
            
                        //"top":"200px"
                                //wtf2 * impW.length-200
            var docsDiv = d3.select("body")
            .select("div.docs_cont")
            .style({
                "width": "440px",
                "position": "absolute",
                "top":"0" ,
                "left" :String(gapscrollWholeDiv+1000+150+rightSizeofKW)+"px",
                "overflow":"auto",
                "border-left": "1px solid #E0E0E0",
                "border-right": "1px solid #E0E0E0",})
             .style("height",function(){
                return String(altezza)+"px"});   
                
            /////////////////////////////
            /////////////////////////////      
               
            
            var ixsqueryData = queryData.map(function(_, ix) {
              return ix;
            });

            ixsqueryData.sort(function(aix, bix) {
              return d3.ascending(+queryData[aix].occ, +queryData[bix].occ);
            });
            ixsqueryData.reverse();
            

            
            var gList = listExpSvg.selectAll("g").data(ixsqueryData, function(ix) {
              return ix;
            });

            gList.exit().remove();

            gListEnter = gList.enter()
            .append("g");
            
            var numRows = 0;
            var numRowsB = 0
            var span = 25
            var span2 = 12
            var maxPerLine = 15
            var updateRigthSize = 0
            /////////////////////////////

            numRows = 0
            gListEnter.append("text").classed("expl", true);
            var maxNumbOfCharac = 5;
            gList.select("text.expl")
            .attr("font-family","Verdana")
            .text(function(d){

                var listaAcc = new Array(queryData[d].exp.length)
                 for (var o = 0; o < queryData[d].exp.length; o++){
                    var concatString =  ""
                    var numbOfChar = queryData[d].exp[o].length
                    for (var i = 0; i < numbOfChar; i++){
                        if (i==maxNumbOfCharac){
                            break }
                        concatString = concatString + queryData[d].exp[o][i];}
                    listaAcc[o] =  concatString;   }
                return listaAcc;})
            .attr("font-size",expSize+1)
            .attr("font-size",function(d,i){
                    lengthOfExps[i] = this.getComputedTextLength();
                    return expSize-1;});


            gList.select("text.expl").transition()
            .duration(350)
            .attr('y', function(d,i){
                if (i != 0){numRows=numRows +Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                return span_labels+30.5 +i * (span)+(span2*numRows);})
            .attr("x",gapscroll + 35);
            

            setTimeout(function(){ 
                numRows = 0
                gList.select("text.expl")
                .attr('y', function(d,i){
                    if (i != 0){numRows=numRows +Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                    return span_labels+30.5 +i * (span)+(span2*numRows);})
                .attr("x",gapscroll + 35);

            }, 350);


            if (queryData.length != 0){
                rightSizeofExp = d3.max(lengthOfExps) + 30}
                //rightSizeofExp = d3.max(lengthOfExps) + 8
            /////////////////////////////
            numRows = 0
            gListEnter.append("circle").classed("selCirc", true);
            
            gList.select("circle.selCirc")
            .attr("r", 4)
            .attr("fill","black")
            .attr("opacity",function(d,i) {
                if (isItClickedExp[d]) {
                    return(100);}
                else {
                    return(0);}});
            
            gList.select('circle.selCirc')
            .transition()
            .duration(350)
            .attr('cy', function(d,i){
                if (i != 0){numRows=numRows +Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                return span_labels+27 +i * (span)+(span2*numRows);})
            .attr("cx", gapscroll + 20);

            setTimeout(function(numRows){
                numRows = 0
                gList.select('circle.selCirc')
                .attr('cy', function(d,i){
                    if (i != 0){numRows=numRows +Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                    return span_labels+27 +i * (span)+(span2*numRows);})
                .attr("cx", gapscroll + 20);

            }, 350);
            
            /////////////////////////////

             listExpSvg.select('text.column_lab1')
            .attr("x",gapscroll + 50)
            .attr("y",25)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(gapscroll + 76)+" 39)")
            .attr("opacity", function(){
                for (var o in isItClicked){
                    if(isItClicked[o]){return 100} }
                    return 0})
            .text("exp.");

             listExpSvg.select('text.column_lab2')
            .attr("x",gapscroll + rightSizeofExp)
            .attr("y",25)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(gapscroll + 26+rightSizeofExp)+" 39)")
            .attr("opacity", function(){
                for (var o in isItClicked){
                    if(isItClicked[o]){return 100} }
                    return 0})
            .text("# docs");
            
            
             listExpSvg.select('text.column_lab3')
            .attr("x",gapscroll + 50+rightSizeofExp)
            .attr("y",25)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(gapscroll + 26+50+rightSizeofExp)+" 39)")
            .attr("opacity", function(){
                for (var o in isItClicked){
                    if(isItClicked[o]){return 100} }
                    return 0})
            .text("# words");
            
            listExpSvg.select('text.column_lab4')
            .attr("x",gapscroll + 100+rightSizeofExp)
            .attr("y",25)
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .attr("transform","rotate(315 "+String(gapscroll + 26+100+rightSizeofExp)+" 39)")
            .attr("opacity", function(){
                for (var o in isItClicked){
                    if(isItClicked[o]){return 100} }
                    return 0})
            .text("scores");
            /////////////////////////////
            numRows = 0
            gListEnter.append("text").classed("occur", true);
            
            gList.select("text.occur")
            .attr("font-family","Verdana")
            .text(function(d,i){
                occWhenFewDocs[i] = queryData[d].occ;
                return queryData[d].occ;})
            .attr("font-size",expSize);


            gList.select("text.occur").transition()
            .duration(350)
            .attr('y', function(d,i){
                if (i != 0){numRows=numRows +Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                return span_labels+30.5 +i * (span)+(span2*numRows);})
            .attr("x",gapscroll + rightSizeofExp);



            setTimeout(function(numRows){
                numRows = 0
               gList.select("text.occur")
                .attr('y', function(d,i){
                    if (i != 0){numRows=numRows +Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                    return span_labels+30.5 +i * (span)+(span2*numRows);})
                .attr("x",gapscroll + rightSizeofExp);

            }, 350);
            
            var maxDoc = d3.max(occWhenFewDocs)
            
            /////////////////////////////

            numRows = 0
            gListEnter.append("text").classed("len", true);
            
            gList.select("text.len")
            .attr("font-family","Verdana")
            .attr("font-size",expSize)
            .text(function(d){
                return queryData[d].exp.length;});
            
      
            gList.select("text.len").transition()
            .duration(350)
            .attr('y', function(d,i){
                if (i != 0){numRows=numRows+Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                return span_labels+30.5 +i * (span)+(span2*numRows);})
            .attr("x",gapscroll + 50+rightSizeofExp);

            setTimeout(function(numRows){
                numRows = 0
                gList.select("text.len")
                .attr('y', function(d,i){
                    if (i != 0){numRows=numRows+Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                    return span_labels+30.5 +i * (span)+(span2*numRows);})
                .attr("x",gapscroll + 50+rightSizeofExp);

            }, 350);

            /////////////////////////////
            numRows = 0
            gListEnter.append("rect").classed("invisible_layer", true);
            
            gList.select('rect.invisible_layer')
            .attr("width", rightSizeofExp-(gapscroll + 35))
            .attr("height", 20)
            .attr("stroke", "black")
            .attr("fill","white")
            .attr("x",gapscroll + 25)
            .attr("y",function(d,i){
                if (i != 0){numRows=numRows+Math.floor(+queryData[ixsqueryData[i-1]].occ/maxPerLine)}
                return span_labels+18 +i * (span)+(span2*numRows);})
            .attr("opacity",0)
            .on("click",function(d,i){
                selectedSquarino = "none"
                whichDocs = "all";
                TPDocs = new Array();
                TNDocs = new Array();
                FPDocs = new Array();
                FNDocs = new Array();
                TNPred = new Array();
                TPPred = new Array();
                FNPred = new Array();
                FPPred = new Array();
                docContent = [];
                isItClickedExp = new Array(queryData.length)
                isItClickedExp[d] = !isItClickedExp[d]
                argGetDoc = [queryData[d].doc_indexes,queryData[d].exp,queryData[d].pred_doc, folderOfDocs]
                allDocs = queryData[d].doc_indexes;
                
                for (var kjb in allDocs){
                    if(argGetDoc[2][kjb]>= thresholdRight && queryData[d].ground_truth[kjb] == 1){
                        TPDocs.push(allDocs[kjb])
                        TPPred.push(argGetDoc[2][kjb])}
                    else if(argGetDoc[2][kjb]>= thresholdRight && queryData[d].ground_truth[kjb] == 0){
                        FPDocs.push(allDocs[kjb])
                        FPPred.push(argGetDoc[2][kjb])}
                    else if(argGetDoc[2][kjb]< thresholdLeft && queryData[d].ground_truth[kjb] == 1){
                        FNDocs.push(allDocs[kjb])
                        FNPred.push(argGetDoc[2][kjb])}
                    else if(argGetDoc[2][kjb]< thresholdLeft && queryData[d].ground_truth[kjb] == 0){
                        TNDocs.push(allDocs[kjb])
                        TNPred.push(argGetDoc[2][kjb])}
                    else{
                        console.log("!£$ error $£!")}
                    }
                    
                getDoc(queryData[d].doc_indexes,queryData[d].exp,queryData[d].pred_doc, folderOfDocs) })
            .on("mouseover",function(d,i){
                var textNow = d3.select(this.parentNode).select("text.expl");
                textNow.attr("font-size",expSize+2).attr("font-weight","bold")
                



                d3.select(this.parentNode).select("text.len")
                .attr("opacity",0.2);

                d3.select(this.parentNode).select("text.occur")
                .attr("opacity",0.2);

                d3.select(this.parentNode).selectAll("g.list_doc_sq")
                .attr("opacity",0.2);



                if(d >= queryData.length) return;  })
            
            .on("mouseout",function(d,i){

                d3.select(this.parentNode).select("text.len")
                .attr("opacity",1);

                d3.select(this.parentNode).select("text.occur")
                .attr("opacity",1);

                d3.select(this.parentNode).selectAll("g.list_doc_sq")
                .attr("opacity",1);

                d3.select(this.parentNode).select("text.expl").text(function(){

                var listaAcc = new Array(queryData[d].exp.length)

                 for (var o = 0; o < queryData[d].exp.length; o++){
                    var concatString =  ""
                    var numbOfChar = queryData[d].exp[o].length
                    for (var i = 0; i < numbOfChar; i++){
                        if (i==maxNumbOfCharac){
                            break }
                        concatString = concatString + queryData[d].exp[o][i];}
                    listaAcc[o] =  concatString;   }

                return listaAcc;})

                d3.select(this.parentNode).select("text.expl")
                .transition()
                .duration(350)
                .attr("font-weight","normal")
                .attr("font-size",expSize-1); }); 


             
             /////////////////////////////
             numRows = 0
             
             var jk = 10000000000
             
             var list_doc_squares = gList.selectAll("g.list_doc_sq").data(function(d,i) {
              // d -- original value
              // d["docs_squares"] -- array [ v_0, v_1, ... ]
              // after map -- array [ [ d, v_0], [d, v_1], ... ]
              return queryData[d].pred_doc.map(function(v) {
                return ([ i, +v, d]); });
            });

              list_doc_squares.exit().remove();

             var list_doc_squares_enter = list_doc_squares.enter().append("g").classed("list_doc_sq", true);
             
             
             list_doc_squares.attr("transform",function(d,i){
                                                    var j = i -(1+Math.floor(i/maxPerLine)*maxPerLine) 
                                                    var tr_x = String(gapscroll + rightSizeofExp+100+12*j);
                                                    var k = Math.floor(i/maxPerLine)
                                                    if (d[0] != 0 && jk != d[0]){numRows=numRows+Math.floor(+queryData[ixsqueryData[d[0]-1]].occ/maxPerLine)}
                                                    jk = d[0]
                                                    var tr_y = String((12*k)+span_labels+20 +d[0] * (span)+(span2*numRows));
                                                    
                                                    return "translate("+ tr_x +","+tr_y+")"});

             list_doc_squares_enter.append("rect").classed("docs",true);
             
             

             
            var docs_squares = gList.selectAll("rect.docs")
            

            
            
            docs_squares.attr("width",10)
            .attr("stroke","black")
            .attr("stroke-width",function(d,i){
                if (selectedSquarino ==  queryData[d[2]].doc_indexes[i]){
                    return 2}
                else {
                    return 0}})
            .attr("height",10)
            .attr("fill",function(d,i) {
                if (d[1]>=thresholdLeft){
                    return colorDist2(d[1]);}
                else {return colorDist3(d[1]);} });

            

                
            /////////////////////////////
            
            var maxPerLineX = maxPerLine;
            if ( maxDoc < maxPerLine) {
                maxPerLineX = maxDoc}
            
            
             listExpSvg.selectAll('line').attr("stroke","#E0E0E0").attr("x1",gapscroll/2 + rightSizeofExp+125+maxPerLineX*11).attr("x2",gapscroll/2 + rightSizeofExp+125+maxPerLineX*11);
             
             
             loadImageFinger.style({"left": String((975-(rightSizeofExp+125+maxPerLineX*11))/2+(rightSizeofExp+125+maxPerLineX*11)-32)+"px"})
             /////////////////////////////


             var sizebuttonc = 20;
             var gapButtons = 3;
             var strwidtCross = 2;
            var startPostion = [gapscrollWholeDiv + 150 + rightSizeofKW +(975-(rightSizeofExp+125+maxPerLineX*11))/2+(rightSizeofExp+125+maxPerLineX*11)-sizebuttonc,65/2-20]
            
            buttonSvg.select("rect.tp")
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if(whichDocs == "tp")
                {return 2}
                else
                {return 0}})  
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill",colorPositive)
            .attr("x",startPostion[0])
            .attr("y",startPostion[1]);
            
            buttonSvg.select("rect.tn")
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if(whichDocs == "tn")
                {return 2}
                else
                {return 0}})             
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill",colorNegative)
            .attr("x",startPostion[0]+ sizebuttonc + gapButtons)
            .attr("y",startPostion[1]+ sizebuttonc + gapButtons);

            
            var leftTop = [startPostion[0],startPostion[1]+ sizebuttonc + gapButtons]
            var rightTop = [leftTop[0]+sizebuttonc,leftTop[1]]
            var leftBottom = [leftTop[0],leftTop[1]+sizebuttonc]
            var rightBottom = [rightTop[0] ,leftBottom[1]]
            
            buttonSvg.select("rect.fp")
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if(whichDocs == "fp")
                {return 2}
                else
                {return 0}})            
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill",colorPositive)
            .attr("x",leftTop[0])
            .attr("y",leftTop[1]);
            
            buttonSvg.select("line.fpl1")
            .attr("stroke-width",strwidtCross)
            .attr("stroke","black")
            .attr("x1",leftTop[0])
            .attr("y1",leftTop[1])
            .attr("x2",rightBottom[0])
            .attr("y2",rightBottom[1]);
            
            buttonSvg.select("line.fpl2")
            .attr("stroke-width",strwidtCross)
            .attr("stroke","black")
            .attr("x1",rightTop[0])
            .attr("y1",rightTop[1])
            .attr("x2",leftBottom[0])
            .attr("y2",leftBottom[1]);
            
            
            var leftTop2 = [startPostion[0]+ sizebuttonc + gapButtons,startPostion[1]]
            var rightTop2 = [leftTop2[0]+sizebuttonc,leftTop2[1]]
            var leftBottom2 = [leftTop2[0],leftTop2[1]+sizebuttonc]
            var rightBottom2 = [rightTop2[0] ,leftBottom2[1]]
            
            buttonSvg.select("rect.fn")
            .attr("stroke","black")
            .attr("stroke-width",function(){
                if(whichDocs == "fn")
                {return 2}
                else
                {return 0}})            
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill",colorNegative)
            .attr("x",leftTop2[0])
            .attr("y",leftTop2[1]);
            
            buttonSvg.select("line.fnl1")
            .attr("stroke-width",strwidtCross)
            .attr("stroke","black")
            .attr("x1",leftTop2[0])
            .attr("y1",leftTop2[1])
            .attr("x2",rightBottom2[0])
            .attr("y2",rightBottom2[1]);
            
            buttonSvg.select("line.fnl2")
            .attr("stroke-width",strwidtCross)
            .attr("stroke","black")
            .attr("x1",rightTop2[0])
            .attr("y1",rightTop2[1])
            .attr("x2",leftBottom2[0])
            .attr("y2",leftBottom2[1]);
            
            buttonSvg.select("rect.tpf")
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill","black")
            .attr("x",startPostion[0])
            .attr("y",startPostion[1])
            .attr("opacity",0)
            .on("click",function(){
            whichDocs = "tp"
                if(TPDocs.length == 0){docContent = [];update();}
                else{getDoc(TPDocs,argGetDoc[1],TPPred,argGetDoc[3])} })
            .on("mouseover", function() {
                d3.select(this)
                .attr("opacity",100);})
            .on("mouseout", function() {
                d3.select(this)
                .attr("opacity",0);});
                
            buttonSvg.select("rect.fpf")
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill","black")
            .attr("x",startPostion[0])
            .attr("y",startPostion[1]+ sizebuttonc + gapButtons)
            .attr("opacity",0)
            .on("click",function(){
            whichDocs = "fp"
                if(FPDocs.length == 0){docContent = [];update();}
                else{getDoc(FPDocs,argGetDoc[1],FPPred,argGetDoc[3])}})
            .on("mouseover", function() {
                d3.select(this)
                .attr("opacity",100);})
            .on("mouseout", function() {
                d3.select(this)
                .attr("opacity",0);});
                
                
            buttonSvg.select("rect.tnf")
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill","black")
            .attr("x",startPostion[0]+ sizebuttonc + gapButtons)
            .attr("y",startPostion[1]+ sizebuttonc + gapButtons)
            .attr("opacity",0)
            .on("click",function(){
            whichDocs = "tn"
                if(TNDocs.length == 0){docContent = [];update();}
                else{getDoc(TNDocs,argGetDoc[1],TNPred,argGetDoc[3])}})
            .on("mouseover", function() {
                d3.select(this)
                .attr("opacity",100);})
            .on("mouseout", function() {
                d3.select(this)
                .attr("opacity",0);});
                
                
            buttonSvg.select("rect.fnf")
            .attr("width",sizebuttonc)
            .attr("height",sizebuttonc)
            .attr("fill","black")
            .attr("x",startPostion[0]+ sizebuttonc + gapButtons)
            .attr("y",startPostion[1])
            .attr("opacity",0)
            .on("click",function(){
            whichDocs = "fn"
                if(FNDocs.length == 0){docContent = [];update();}
                else{getDoc(FNDocs,argGetDoc[1],FNPred,argGetDoc[3])}})
            .on("mouseover", function() {
                d3.select(this)
                .attr("opacity",100);})
            .on("mouseout", function() {
                d3.select(this)
                .attr("opacity",0);});
            
             /////////////////////////////
             list_doc_squares_enter.append("line").classed("docs_yeh",true);
             var docs_lines1 = gList.selectAll("line.docs_yeh")
            

            
            
            docs_lines1.attr("stroke","black")
            .attr("opacity",function(d,i) {
                if (d[1]>=thresholdRight && +queryData[d[2]].ground_truth[i] == 0){
                    return 1;}
                else if (d[1]<thresholdLeft && +queryData[d[2]].ground_truth[i] == 1) {
                    return 1;}
                else {
                    return 0} })
             .attr("x1",0)
             .attr("x2",10)
             .attr("y1",0)
             .attr("y2",10);

                

            

                
            /////////////////////////////
             
             list_doc_squares_enter.append("line").classed("docs_yeh2",true);
             var docs_lines2 = gList.selectAll("line.docs_yeh2")
            

            
            
            docs_lines2.attr("stroke","black")
            .attr("opacity",function(d,i) {
                if (d[1]>=thresholdRight && +queryData[d[2]].ground_truth[i] == 0){
                    return 1;}
                else if (d[1]<thresholdLeft && +queryData[d[2]].ground_truth[i] == 1) {
                    return 1;}
                else {
                    return 0} })
             .attr("x1",10)
             .attr("x2",0)
             .attr("y1",0)
             .attr("y2",10);
             
             /////////////////////////////
             
                         
            list_doc_squares_enter.append("rect").classed("docs_inv",true);

            var docs_squares_inv = gList.selectAll("rect.docs_inv")
            

            
            
            docs_squares_inv.on("click",function(d,i){
                selectedSquarino = queryData[d[2]].doc_indexes[i]
                docContent = []
                argGetDoc = new Array(4);
                TPDocs = new Array();
                TNDocs = new Array();
                FPDocs = new Array();
                FNDocs = new Array();
                TNPred = new Array();
                TPPred = new Array();
                FNPred = new Array();
                FPPred = new Array();
                isItClickedExp = new Array(queryData.length);
                var miniList = new Array(1);
                var miniList2 = new Array(1);
                miniList[0] = +queryData[d[2]].doc_indexes[i]
                miniList2[0] = +queryData[d[2]].pred_doc[i]
                if (d[1]>=thresholdRight && +queryData[d[2]].ground_truth[i] == 0){
                    whichDocs = "fp";
                    FPDocs.push(miniList) 
                    FPPred.push(miniList2) }
                else if (d[1]<thresholdLeft && +queryData[d[2]].ground_truth[i] == 1) {
                    whichDocs = "fn";
                    FNDocs.push(miniList)
                    FNPred.push(miniList2)}
                else if (d[1]<thresholdLeft && +queryData[d[2]].ground_truth[i] == 0) {
                    whichDocs = "tn";
                    TNDocs.push(miniList)
                    TNPred.push(miniList2)}
                else if (d[1]>=thresholdRight && +queryData[d[2]].ground_truth[i] == 1) {
                    whichDocs = "tp";
                    TPDocs.push(miniList)
                    TPPred.push(miniList2)}
                else{console.log("error")}
                argGetDoc=[miniList,queryData[d[2]].exp,miniList2, folderOfDocs]
                getDoc(miniList,queryData[d[2]].exp,miniList2, folderOfDocs);
                })
            .on("mouseover",function(d,i){
                d3.select(this).attr("fill","black");
                d3.select(this).attr("opacity",1);})
            .on("mouseout",function(d,i){
                d3.select(this).attr("opacity",0);
                d3.select(this).attr("fill",function(d,i) {
                if (d[1]>=thresholdLeft){
                    return colorDist2(d[1]);}
                else {return colorDist3(d[1]);}
                });})
            .attr("width",10)
            .attr("height",10)
            .attr("fill","black")
            .attr("opacity",0);

             /////////////////////////////
             /////////////////////////////
             
             sizeOfStripe = 968-(rightSizeofExp+125+maxPerLineX*11+25)
             heightOfStripe = 25
             lineFeatXFactor = sizeOfStripe/numbFeat
             
             var fingerPrintsG = listExpSvg.selectAll("g.fingpr").data(docContent);

              fingerPrintsG.exit().remove();

             var fingerPrintsEnter = fingerPrintsG.enter().append("g").classed("fingpr", true);
             
             
             fingerPrintsG.attr("transform",function(d,i){
                                             return "translate("+String(rightSizeofExp+125+maxPerLineX*11+25)+","+String(span_labels+20+(15+heightOfStripe)*i)+")"});

             fingerPrintsEnter.append("rect").classed("fgpCont",true);
             
             fingerPrintsG.select("rect")
             .attr("stroke-width",3)          
             .attr("width",sizeOfStripe)
             .attr("height",heightOfStripe)
             .attr("x",0)
             .attr("y",0)
             .on("mouseover",function(d,i){
                console.log($("#"+String(i)).offset())

                $('#docs').scrollTop($("#"+String(i)).offset().top - $('#docs').offset().top + $('#docs').scrollTop());
 
                d3.select(this).attr("stroke","black");
                var i_old = i;
                var highlight = "yellow";
                if (d.coloratio>=thresholdLeft){
                    highlight = colorDist2(d.coloratio);}
                else {highlight = colorDist3(d.coloratio);}
                docsList.select('p.content')
                .style("background-color",function(d,i){
                        if (i == i_old){
                            return highlight}
                        else{
                            return "none"} } )})
                .on("mouseout",function(d,i){
                d3.select(this).attr("stroke","none");
                docsList.select('p.content')
                .style("background","none");})
             .attr("fill",function(d,i) {
                if (d.coloratio>=thresholdLeft){
                    return colorDist2(d.coloratio);}
                else {return colorDist3(d.coloratio);}});
             
             var cells = fingerPrintsG.selectAll("line.cell")
             .data(function(d,i){
                    var ones = new Array();
                    for (var i in d.vector){
                        var expWord = false
                        if (d.vector[i] == 1){
                            if(d.highlight.indexOf(+i) >= 0){
                                expWord = true}
                            ones.push([i,d.scores[i],expWord])}}
                    return(ones);});
            
             cells.exit().remove();
            
             cells.enter().append("line").classed("cell", true);
             
             cells.attr("stroke",function(d,i){
                    if (d[2]){return "green"}
                    else {return "black"}})
             .attr("stroke-width",function(d,i){
                    if (d[2]){return 3}
                    else {return 3}})
             .attr("opacity",function(d,i){
                    if (d[2]){return 1}
                    else {return 0.3}})
             .attr("x1",function(d,i){
                    return d[0]*lineFeatXFactor})
             .attr("x2",function(d,i){
                    return d[0]*lineFeatXFactor})   
             .attr("y1",function(d,i){
                    if (d[2]){return -5}
                    else {return 0}})
             .attr("y2",function(d,i){
                    if (d[2]){return heightOfStripe+5}
                    else {return heightOfStripe}});
             
             
             /////////////////////////////
             /////////////////////////////
             
            var docsList = docsDiv.selectAll("div").data(docContent);

            docsList.exit().remove();

            var docsListEnter = docsList.enter()
            .append("div").classed("divPerReview", true);
            
            
            docsListEnter.append("p").classed("content", true);
            docsListEnter.append("hr");
            docsList.style({
                "position": "relative"});
            
            docsList.select('p.content')
            .attr('id',function (d,i){return String(i)})
            .html(function (d,i){
                var metaTitle = "<u>" + d.meta + "</u><br><br>"
                if (d.is_it_txt == "yes"){
                    var testo = d.content;
                    if (whichDocFormat == "full"){
                        testo = d.content;}
                    if (whichDocFormat == "periods"){
                        testo = d.periods;
                        testo = replaceAll(testo, "...", "..<br>..")}
                    if (whichDocFormat == "words"){
                        testo = d.words;
                        testo = replaceAll(testo,".. ..","..<br>..")} }
                else{
                    buttonSvg.select("rect.fkperiods").attr("opacity",0.75);
                    buttonSvg.select("rect.fkwords").attr("opacity",0.75);
                    var testo = "" 
                    for(db in d.content){
                        testo = testo + d.content[db] + ", "
                    }}

                    var listaExp = d.expl;
                    for (var iki in listaExp){
                        testo = testo.replace(listaExp[iki],"<strong>"+listaExp[iki]+"</strong>")}
                    testo = metaTitle + testo 
                    return testo}) 
            .style({
                "font-family": "Verdana",
                "font-size": "15px",
                "position": "relative",
                "left": "10px",
                "right":"40px",
                "width":String(400)+"px"})
            .on("mouseover",function(d,i){
                var z_old = i;
                var highlight = "yellow";
                if (d.coloratio>=thresholdLeft){
                    highlight = colorDist2(d.coloratio);}
                else {highlight = colorDist3(d.coloratio);}
                
                d3.select(this).style("background-color",highlight);
                
                fingerPrintsG.select("rect")
                .attr("stroke",function(d,i){
                        if (i == z_old){
                            return "black"}
                        else{
                            return "none"} } )})

                            
             .on("mouseout",function(d,i){
                d3.select(this).style("background","none");
                fingerPrintsG.select("rect")
                .attr("stroke",function(d,i){
                            return "none"} )}); }
                        
       function newList(parola,indice,obj){
            loadImageExp.transition()
            .duration(500).style({ "opacity": "1"});
            work.post("listFromQuery", "queryexp", {
              "l": thresholdLeft,
              "r": thresholdRight,
              "q": parola.join(","),
              "token" : pwd,
            }, function(newData) {
              
              queryData = newData.query_result;
              isItClickedExp = new Array(queryData.length);
              lengthOfExps = new Array(queryData.length);
              wordsLeft = newData.words_to_select;
              update(); 
              
              }); 
              
              }

     function getDoc(ind,exp,color,fold){
            loadImageDocs.transition()
            .duration(500).style({ "opacity": "1"});
            loadImageFinger.transition()
            .duration(500).style({ "opacity": "1"});
            work.post("contentOfDoc", "docontent", {
              "l": thresholdLeft,
              "r": thresholdRight,
              "i": ind,
              "e": exp,
              "c" : color,
              "f" : fold,
              "token" : pwd,
            }, function(newData) {
               
               docContent = [];
               docContent = newData;
               numbFeat = newData[0].vector.length
               update();
              
            });
            
            
            } 
            
       function newSort(index,array,errSort,freqSort,sentSort){
            if (errSort){
                index.sort(function(aix, bix) {
                    return d3.ascending(+array[aix].freq, +array[bix].freq); });
                index.reverse();
                errSort = false;
                freqSort = true;
                sentSort = false;}
            else if (freqSort){
                index.sort(function(aix, bix) {
                    return d3.ascending(+array[aix].ratio, +array[bix].ratio); });
                index.reverse();
                errSort = false;
                freqSort = false;
                sentSort = true;}
            else if (sentSort){
                index.sort(function(aix, bix) {
                    return d3.ascending(+array[aix].errors, +array[bix].errors); });
                index.reverse();
                errSort = true;
                freqSort = false;
                sentSort = false;}
             else {
                console.log('wtf')}

             return [errSort,freqSort,sentSort] } }
       function getMax(arr, prop) {
       
        var max;
        for (var i=0 ; i<arr.length ; i++) {
            if (!max || parseInt(arr[i][prop]) > parseInt(max[prop]))
                max = arr[i];
        }
        return max; }


        function hashCode(sttringa){
        var hash = 0, i, chr, len;
        if (sttringa.length === 0) return hash;
        for (i = 0, len = sttringa.length; i < len; i++) {
        chr   = sttringa.charCodeAt(i);
        hash  = ((hash << 5) - hash) + chr;
        hash |= 0; // Convert to 32bit integer
        }
        return hash;
        };  
        
        function replaceAll(str, find, replace) {
        var $r="";
        while($r!=str){ 
        $r = str;
        str = str.replace(find, replace);
        }
        return str;
        }

     </script>
    </body>
</html>
