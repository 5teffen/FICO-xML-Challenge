<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Visual Interface</title>
    <meta name="author" content="NYU UGR Team">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
    <link href="/static/css/scratchstyle-light.css" rel="stylesheet" type="text/css">
    <!-- D3.js and jQuery source -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- SVG scripts -->
    <script type="text/javascript" src="/static/js/main_graph.js"></script>
    <script type="text/javascript" src="/static/js/direction_signs.js"></script>
    <script type="text/javascript" src="/static/js/square_graphs_simple.js"></script>
    <script type="text/javascript" src="/static/js/occ_bar.js"></script>
    <script type="text/javascript" src="/static/js/mini_graph.js"></script>
    <script type="text/javascript" src="/static/js/percentage_bar.js"></script>
    <script type="text/javascript" src="/static/js/squares.js"></script>
  </head>

  <body>
    <div class="main">
      <div class="left-sidebar">
        <header class="site-header">
          <h1>FICO CHALLENGE</h1>
        </header>
        <nav class="left-nav">
          <ul>
            <li>
              <a href="/global">
                GLOBAL EXPLANATION
              </a>
             </li>
            <li><a href="/individual">LOCAL EXPLANATIONS</a></li>
          </ul>
        </nav>

        <nav class="id-list">
          <br>
          <br>
          <br>
          MODEL SUMMARY
        </nav>
      </div>
      
      <div class="right-side-global" id="demo">



        <div id="left-panel">
          <div class="btn-group">
            <button class="algo-button" id="key-button" onclick="buttonRequest(this)">Key Features</button>
            <button class="algo-button" id="chg-button"onclick="buttonRequest(this)">Changes</button>
          </div>
        </div>

        <div id="right-panel">
          <table id="feature-table2">
            <tr>

              <td id="middle-col">
                <!-- <nav id="middle-nav"> -->
                  <ul id="combination-list">
                  </ul>
                <!-- </nav> -->
              </td>
              
              <td id="right-part">
                <div id="right-part-div">        
                </div>
              </td> 

            </tr>
          </table>
        </div>

      </div>
    </div>










    <script>
    
      var ft_names = ["External Risk Estimate", 
                        "Months Since Oldest Trade Open",
                        "Months Since Last Trade Open",
                        "Average Months in File",
                        "Satisfactory Trades",
                        "Trades 60+ Ever",
                        "Trades 90+ Ever",
                        "% Trades Never Delq.",
                        "Months Since Last Delq.",
                        "Max Delq. Last 12M",
                        "Max Delq. Ever",
                        "Total Trades",
                        "Trades Open Last 12M",
                        "% Installment Trades",
                        "Months Since Most Recent Inq",
                        "Inq Last 6 Months",
                        "Inq Last 6 Months exl. 7 days",
                        "Revolving Burden",
                        "Installment Burden",
                        "Revolving Trades w/ Balance:",
                        "Installment Trades w/ Balance",
                        "Bank Trades w/ High Utilization Ratio",
                        "% Trades w/ Balance"]

      var selected_fts = [];

      // Draw gliph for prediction category
      function addSquare(elemn, category, size) {
        var sqr = document.createElement("img");
          if (category == "FN"){
            sqr.src="/static/images/square2-min.jpg";
          }
          else if (category == "TN"){
            sqr.src="/static/images/square4-min.jpg";
          }
          else if (category == "FP"){
            sqr.src="/static/images/square1-min.jpg";
          }
          else if (category == "TP"){
            sqr.src="/static/images/square3-min.jpg";
          }
          else if (category == "NA"){
            sqr.src="/static/images/square5-min.jpg";
          } 
          sqr.height=size;
          sqr.width=size;
          sqr.id = "category-img";
          sqr.style.margin = "0px 0px 0px 0px";
          document.getElementById(elemn).append(sqr);
      }

      // Handles IDs from search bar
      function formHandle(event) {
        if (event.which == 13 || event.keyCode == 13){
          makeRequest('form', 0);
          return false;
        }
      }

      // Handles checkbox for density plot
      function checkHandle(event) {
        makeRequest("check", 0);
        return false;   
      }

      var txtFile;

      // Get preprocessed csv file
      function fetch_csv(){
        txtFile = new XMLHttpRequest();
        txtFile.onreadystatechange = initContents;
        txtFile.open("GET", "/static/data/pre_data1.csv");
        txtFile.send()
      }
      
      var pre_array = [];
      function initContents() {
        if (txtFile.readyState === XMLHttpRequest.DONE) {
          if (txtFile.status === 200) {
            var rows = txtFile.responseText.split("\n");
            for (var i = 0; i < rows.length; i++) {
              var cells = rows[i].split(",");
              pre_array.push(cells);
            }
          }
        }
      }

      var httpRequest;

      // Individual explanations
      function makeRequest(source, sample) {
        httpRequest = new XMLHttpRequest();
        if (!httpRequest) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }
        if (source == 'form') {
          var s = document.getElementById("search-bar").value;
          document.getElementById("search-bar").value="";
        }
        else if (source == 'list') {
          var s = sample.id.substring(5);
        }
        else if (source == 'global') {
          var s = sample.toString();
        }
        else {
          var s = document.getElementById("id-display").innerHTML.substring(4);
        }
        
        httpRequest.onreadystatechange = alertContents;
        httpRequest.open('GET', '/instance?sample='+s);
        httpRequest.send();
        return false;
      }

      // Right panel mini graphs
      function makeRequest2(feature) {
        httpRequest = new XMLHttpRequest();
        if (!httpRequest) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }

        var anch_col = 6;
        var chg_col = 3;
        var chg_val = 1;
        
        httpRequest.onreadystatechange = alertContents2;
        httpRequest.open('GET', '/glob_feat?anchor='+anch_col.toString()+'&'+'change='+chg_col.toString()+'&'+'change_val='+chg_val.toString());
        httpRequest.send();
        return false;
      }

      // Middle panel graphs
      function makeRequest3(features) {
        httpRequest = new XMLHttpRequest();
        if (!httpRequest) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }

        // MAKE REQUEST TO GET ELEMENTS FOR MIDDLE PANEL

        
        req_arr = [];

        if (features[0] == -1){
          req_arr.push(-1);
        }
        else {
          for (i=0; i<features.length; i++) {
            req_arr.push(ft_names.indexOf(features[i].innerHTML));
            features[i].style.fontSize = "13px";
            features[i].style.fontWeight = "bold"; 
          }
        }

        console.log(req_arr);
        
        httpRequest.onreadystatechange = alertContents3;
        httpRequest.open('GET', '/first_panel?features=['+req_arr+']');
        httpRequest.send();
        return false;
      }

      // Left panel global
      function makeGlobRequest() {
        httpRequest = new XMLHttpRequest();
        if (!httpRequest) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }
        
        httpRequest.onreadystatechange = alertGlobContents;
        httpRequest.open('GET', '/glob_req');
        httpRequest.send();
        return false;
      }

      // Style buttons and send request
      function buttonRequest(elem) {

        if (elem.innerHTML == "Key Features") {
          elem.style.backgroundColor = "gray";
          var c_but = document.getElementById('chg-button');
          c_but.style.backgroundColor = "silver";
        }
        else {
          elem.style.backgroundColor = "gray";
          var c_but = document.getElementById('key-button');
          c_but.style.backgroundColor = "silver";
        }
        makeGlobRequest();
      }

      // Individual explanations
      function alertContents() {

        if (httpRequest.readyState === XMLHttpRequest.OPENED) {
          document.getElementsByClassName("d3-space")[0].innerHTML="";
          var load_wrap = document.createElement("div");
          load_wrap.className = "loader_wrap";
          var loader = document.createElement("div");
          loader.className = "lds-dual-ring";
          load_wrap.append(loader);
          document.getElementsByClassName("d3-space")[0].append(load_wrap);
        }

        else if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            //Do stuff with the response

            var resp_arr = httpRequest.responseText.split('~');
            var testData = [];
            var densityData = [];
            for (i=0; i<23; i++){
              testData.push(JSON.parse(resp_arr[i]));
            }
            for (i=0; i<23; i++){
              densityData.push(JSON.parse(resp_arr[i+23]));
            }

            var resp = JSON.parse(resp_arr[46]);
            
            var index = resp['sample'].toString();
            var trans_sample = resp['trans_sample'].toString();
            var good_percent = resp['good_percent'];
            var correct = parseInt(resp['model_correct']);
            var category = resp['category'];
            var result = resp['predicted'];
            var disp_percent = good_percent;

            document.getElementById("id-display").innerHTML = "ID: " + index;
            document.getElementById("model-display").innerHTML = "";
            var image_x = document.getElementById('category-img')
            image_x.parentNode.removeChild(image_x);
            addSquare("container", category, 45);
            draw_percent_bar(disp_percent);
            document.getElementsByClassName("cat-text")[0].innerHTML = category;
            document.getElementsByClassName("d3-space")[0].innerHTML = "";

            if (trans_sample == '-9') {
              document.getElementsByClassName("d3-space")[0].innerHTML = "SPECIAL CASE";
            }
            else {
              document.getElementById("check-density").style.display = "inline";
              document.getElementById("check-text").innerHTML = "Density distribution";
              if (document.getElementById("check-density").checked == true){
                draw_graph(testData, densityData, result);
              }
              else {
                draw_graph(testData, "no", result);
              }
            }
          } else {
            alert('HttpRequest Error')
          }
        }
      }

      // Right panel mini graphs
      function alertContents2() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            //Do stuff with the response
            var resp_arr = httpRequest.responseText;
            var miniData = [];
            miniData = JSON.parse(resp_arr);
            draw_all_graphs(miniData);

            setTimeout(function(){document.getElementById("right-part").onclick = function() {redirect_to_instance()}}, 700);

            // document.getElementById("right-part").onclick = redirect_to_instance;
            // document.getElementById("right-part-div").onclick = redirect_to_instance; 
            
          }
          else {
              alert('HttpRequest Error')
          }
        }
      }

      // Middle panel graphs
      function alertContents3() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            //Do stuff with the response

            var resp_arr = httpRequest.responseText;
            if (resp_arr == ""){
              document.getElementById("combination-list").innerHTML = "";
            }
            else{
              var middleData = [];
              middleData = JSON.parse(resp_arr);
              document.getElementById("combination-list").innerHTML = "";

              for (var j = 0; j < middleData.length; j++) {
                var li = document.createElement("li");
                var li_div = document.createElement("div");

                // li.innerHTML = j.toString();
                li.id = "middle-link-" + j.toString();
          
                li_div.id = "middle-graph-" + j.toString();
                // li_div.innerHTML = "MID GRAPH";
                li.onclick = function () { makeRequest2(li.innerHTML); };
                

                li.append(li_div);
                document.getElementById("combination-list").append(li);
                draw_all_squares(middleData[j], 14, "#"+li_div.id);
                var br = document.createElement("br");
                document.getElementById("combination-list").append(br);
              }
            }
          }
          else {
              alert('HttpRequest Error')
          }
        }
      }

      // Left panel global
      function alertGlobContents() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            //Do stuff with the response
            // var resp = JSON.parse(httpRequest.responseText);
            var resp_arr = httpRequest.responseText;
            var totalData = JSON.parse(resp_arr);
            var monot_arr = [1,1,1,1,1,-1,-1,1,1,1,1,0,-1,0,1,-1,-1,-1,-1,0,0,-1,0];

            var barData = totalData[2];
            var keySort = totalData[0];
            var chgSort = totalData[1];

            document.getElementById("bar-div-header").innerHTML = '';

            if (document.getElementById("chg-button").style.backgroundColor == "gray"){
              draw_occurance_text("chg");
              for (i=0; i<23; i++){
                document.getElementById("ft-div-" + i.toString()).innerHTML = '';
                document.getElementById("monot-" + i.toString()).innerHTML = '';
                draw_occurance_bar(barData[chgSort[i]][2],barData[chgSort[i]][3],i);
                draw_dir(monot_arr[chgSort[i]], i);
                document.getElementById("bar-div-header").style.marginRight = "5px";
                document.getElementById("feat-" + i.toString()).innerHTML = ft_names[chgSort[i]];
                document.getElementById("feat-" + i.toString()).onclick = function () {flip_feature(this);};
              }
            }
            else{
              draw_occurance_text("key");
              for (i=0; i<23; i++){
                document.getElementById("ft-div-" + i.toString()).innerHTML = '';
                document.getElementById("monot-" + i.toString()).innerHTML = '';
                draw_occurance_bar(barData[keySort[i]][0],barData[keySort[i]][1],i);
                draw_dir(monot_arr[keySort[i]], i);
                document.getElementById("bar-div-header").style.marginRight = "16px";
                document.getElementById("feat-" + i.toString()).innerHTML = ft_names[keySort[i]];
                document.getElementById("feat-" + i.toString()).onclick = function () { flip_feature(this);};
              }
            }         
          }
          else {
              alert('HttpRequest Error');
          }
        }
      }

      // Initialize contents
      function prep_content(callback0, callback1, callback2) {

        // callback0();

        // // setTimeout(function(){ alert("Hello"); }, 3000);
        // setTimeout(function(){ callback1();

        // callback2(); }, 50);
      }

      // Add loading animation
      function add_loader() {
        document.getElementsByClassName("id-list")[0].innerHTML="";
        var load_wrap = document.createElement("div");
        load_wrap.className = "loader_wrap";
        var loader = document.createElement("div");
        loader.className = "lds-dual-ring";
        load_wrap.append(loader);
        document.getElementsByClassName("id-list")[0].append(load_wrap);
      }

      // Initialize left bar list of IDs
      function id_list(){
        var samples = 10459;
        var list_cont = document.createElement("ul");
        for (i = 1; i <= samples; i++) {
          var para = document.createElement("li");
          para.innerHTML = "ID " + i.toString();
          para.id = "link-" + i.toString();
          para.onclick = function () { makeRequest('list', this); };
          var li_div = document.createElement("div");
          li_div.style.width = "75px";
          li_div.style.float = "right";
          li_div.style.margin = "0px 25px 0px 0px";
          li_div.id = "link-div-" + i.toString();
          para.append(li_div);
          list_cont.append(para);
        }
        console.log("LIST");
        document.getElementsByClassName("id-list")[0].innerHTML="";
        document.getElementsByClassName("id-list")[0].append(list_cont);
      }

      // Draw cateogry gliphs for left bar
      function add_images() {
        for (var i = 1; i < pre_array.length; i++) {

          var sqr = document.createElement("img");
          if (pre_array[i][2].trim() == "FN"){
            sqr.src="/static/images/square2-min.jpg";
          }
          else if (pre_array[i][2].trim() == "TN"){
            sqr.src="/static/images/square4-min.jpg";
          }
          else if (pre_array[i][2].trim() == "FP"){
            sqr.src="/static/images/square1-min.jpg";
          }
          else if (pre_array[i][2].trim() == "TP"){
            sqr.src="/static/images/square3-min.jpg";
          } 
          else if (pre_array[i][2].trim() == "NA"){
            sqr.src="/static/images/square5-min.jpg";
          } 
          sqr.height="15";
          sqr.width="15";
          sqr.style.borderRadius = "50%";
          sqr.style.verticalAlign = "middle";
          sqr.style.margin = "4px 0px 0px 0px";
          sqr.style.float = "left";
          var link_string = pre_array[i][3] + "\xa0 \xa0"  + pre_array[i][4];
          document.getElementById("link-div-"+i.toString()).innerHTML = link_string;
          document.getElementById("link-div-"+i.toString()).append(sqr);
          
        }
        console.log("IMGS");
      }

      // Initialize feature list for global
      function ft_list() {
        var features = 23;

        var ft_table = document.createElement("table");
        ft_table.id = "feature-table1";

        // Header

        var tr = document.createElement("tr");
        var td = document.createElement("td");
        var ft_div = document.createElement("div");
        var bar_div = document.createElement("div");
        var monot = document.createElement("div");

        monot.innerHTML = "Monot.";
        monot.className = "monot-div";

        ft_div.className = "ft-div-header";
        td.id = "ft-header";

        bar_div.className = "bar-div";
        bar_div.id = "bar-div-header";

        var link = document.createElement("a");

        link.innerHTML = "Feature Name";
        link.style.maxWidth = "125px"; 
        link.id = "feat-header";

        ft_div.append(link);
        td.append(monot);
        td.append(ft_div);
        td.append(bar_div);
        tr.append(td);
        ft_table.append(tr);

        for (i = 0; i < features; i++) {
          var tr = document.createElement("tr");
          var td = document.createElement("td");
          var ft_div = document.createElement("div");
          var bar_div = document.createElement("div");
          var monot = document.createElement("div");

          monot.className = "monot-div";
          monot.id = "monot-" + i.toString();

          ft_div.className = "ft-div";

          bar_div.className = "bar-div";
          bar_div.id = "ft-div-" + i.toString();

          var loc_i = i;

          var link = document.createElement("a");

          // link.innerHTML = ft_names[i];
          link.style.maxWidth = "125px"; 
          link.id = "feat-" + i.toString();
          link.href = "#right-panel";

          ft_div.append(link);
          td.append(monot);
          td.append(ft_div);
          td.append(bar_div);
          tr.append(td);
          ft_table.append(tr);
        }

        document.getElementById("left-panel").append(ft_table);

        var reset = document.createElement("button");
        reset.innerHTML = "Reset";
        reset.id = "reset-button";
        reset.onclick = function(){ resetFeatures(); };
        document.getElementById("left-panel").append(reset);
      }

      function redirect_to_instance() {
        window.location.replace("http://localhost:5005/individual?sample=52");       
      }

      function resetFeatures() {
        selected_fts = [-1];
        
        for (i=0; i<23; i++){
          document.getElementById("feat-" + i.toString()).style.fontSize = "12px";
          document.getElementById("feat-" + i.toString()).style.fontWeight = "550";
        }
        makeRequest3(selected_fts);
      }

      function flip_feature(elemn) {
        console.log(selected_fts);
        var index = selected_fts.indexOf(-1);
        if (index > -1) {
          selected_fts.splice(index, 1);
        }
        if (selected_fts.includes(elemn)){
          index = selected_fts.indexOf(elemn);
          selected_fts.splice(index, 1);
          elemn.style.fontSize = "12px";
          elemn.style.fontWeight = "550";
          makeRequest3(selected_fts);
        }
        else{
          console.log("enter)=");
          selected_fts.push(elemn);
          makeRequest3(selected_fts);
        }
      }

      $.when( fetch_csv() ).then(function(){setTimeout(function(){prep_content(add_loader, id_list, add_images); }, 700)});

      ft_list();

      makeGlobRequest();

    </script>

  </body>

</html>